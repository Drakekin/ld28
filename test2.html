<!DOCTYPE html>
<html>
<head>
    <title>You Only Get One (Disk)</title>
    <script src="perlin.js"></script>
    <script src="jquery-1.10.2.min.js"></script>
    <script src="three.min.js"></script>
    <script src="voroni.min.js"></script>
    <script src="pratchett.js"></script>
    <style>
        @font-face {
            font-family: 'orange';
            src: url('tangerine_regular-webfont.eot');
            src: url('tangerine_regular-webfont.eot?#iefix') format('embedded-opentype'),
                 url('tangerine_regular-webfont.woff') format('woff'),
                 url('tangerine_regular-webfont.ttf') format('truetype'),
                 url('tangerine_regular-webfont.svg#tangerineregular') format('svg');
            font-weight: normal;
            font-style: normal;
        }
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'orange', cursive;
            font-size: 1.95em;
        }
        .banner {
            border-style: solid;
            border-width: 17px 34px 22px 35px;
            -moz-border-image: url(scroll.png) 17 34 22 35 stretch;
            -webkit-border-image: url(scroll.png) 17 34 22 35 stretch;
            -o-border-image: url(scroll.png) 17 34 22 35 stretch;
            border-image: url(scroll.png) 17 34 22 35 fill stretch;
            position: fixed;
            left: 0;
            right: 0;
            z-index: 1000;
            text-align: center;
            margin: auto;
        }
        #namebanner {
            width: 200px;
            bottom: 20px;
        }
        #dialoguebanner {
            width: 40%;
            top: 60px;
            z-index: 6000 !important;
        }
        #statusbanner {
            width: 50%;
            min-width: 200px;
            top: 20px;
        }
        canvas {
            z-index: 10;
        }
    </style>
</head>
<body>
<img src="ground.png" id="ground_tex" hidden>
<div id="statusbanner" class="banner"></div>
<div id="dialoguebanner" class="banner"></div>
<div id="namebanner" class="banner"></div>
<script>
    var camera, scene, renderer, disk, height_map, cities, projector, voroni,
        land_routes = [], sea_routes = [], diagram, locator, time = 0, dialogue = false;
    var selected = null, city_name_banner = $("#namebanner"), status_banner = $("#statusbanner"), 
        dialogue_banner = $("#dialoguebanner");
    var home, fortress, port, player, advancing = 0, tickets = 1, daughter = false;
    var scheduled_events = {};
    
    city_name_banner.hide();
    dialogue_banner.hide();
    
    function display_dialogue(text, options) {
        dialogue_banner.html("<p>" + text + "</p>");
        for (var a in options) {
            var link = $("<a/>", {href: "javascript:void(0)"});
            link.html(options[a].text + "<br>");
            link.click(options[a].func);
            dialogue_banner.append(link);
        }
        dialogue = true;
        dialogue_banner.show();
    }
    
    document.body.onload = function () {
        renderer = new THREE.WebGLRenderer();
        projector = new THREE.Projector();
        voroni = new Voronoi();
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(0, -60, 50);
        camera.lookAt(new THREE.Vector3(0,0,-15));
        
        scene = new THREE.Scene();
        
        var gradient_source = document.getElementById("ground_tex");
        var gradient_canvas = document.createElement("canvas").getContext("2d");
        gradient_canvas.canvas.width = 256;
        gradient_canvas.canvas.height = 1;
        gradient_canvas.drawImage(gradient_source,0,0);

        var ground = {
            water_level: 125,
            water_level_tex: 153,
            gradient: gradient_canvas.getImageData(0,0,256,1).data
        }, targets = {
            texture: document.createElement("canvas").getContext("2d"),
            bump: document.createElement("canvas").getContext("2d"),
            specular: document.createElement("canvas").getContext("2d")
        };
        height_map = create_heightmap(targets, 512, 0.2, {x: 0, y:0}, ground, +new Date);
        disk = create_disk(targets);
        scene.add(disk);
        
        locator = new THREE.Mesh(
            //new THREE.CylinderGeometry(0.5, 0, 1, 3, 1, false),
            new THREE.CylinderGeometry(0, 1, 8, 3),
            new THREE.MeshBasicMaterial({color: 0x52F00A})
        );
        scene.add(locator);
        
        cities = generate_cities(height_map, 512, 32, 5);
        home = random_element(cities);
        player = home;
        while (fortress == home || fortress == undefined) {
            fortress = random_element(cities);
        }
        while (port == home || port == undefined) {
            port = random_element(cities);
        }
        diagram = voroni.compute(cities, {xl: -513, xr: 513, yt: -513 ,yb: 513});
        
        for (var n in cities) {
            var city = cities[n];
            var marker_colour = 0xffffff;
            if (city.voronoiId == home.voronoiId) {
                marker_colour = 0x46F21B;
            } else if (city.voronoiId == port.voronoiId) {
                marker_colour = 0x4592D1;
            } else if (city.voronoiId == fortress.voronoiId) {
                marker_colour = 0xE85669;
            }
            city.neighbours = get_neighbours(city, diagram);
            var spot = new THREE.Mesh(
                new THREE.SphereGeometry(0.5, 4, 4),
                new THREE.MeshBasicMaterial({color: marker_colour})
            );
            var pos = city.position.clone();
            pos.multiplyScalar(50/512);
            pos.y = -pos.y;
            spot.position = pos;
            scene.add(spot);
            city.marker = spot;
            targets.texture.fillStyle = "black";
            targets.texture.fillRect(city.position.x+512-5,city.position.y+512-5,10,10);
        }
        disk.material.map.needsUpdate = true;

        var light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(50,50,50);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x202020));
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize, false);
        
        function select_city(event) {
            var vector = new THREE.Vector3(
                (event.clientX / window.innerWidth) * 2 - 1,
                -(event.clientY / window.innerHeight ) * 2 + 1,
                0.5
            );
            var raycaster = projector.pickingRay(vector, camera);
            var intersections = raycaster.intersectObject(disk);
            if (intersections.length > 0) {
                var point = intersections[0].point;
                point.y = -point.y;
                point.multiplyScalar(512/50);
                for (var c in cities) {
                    var d = point.distanceTo(cities[c].position);
                    if (d < 25) {
                        return cities[c];
                    }
                }
            }
        }
        window.addEventListener("mousedown", function (e) {
            if (time < advancing || dialogue) return;
            var city = select_city(e);
            if (city != undefined) {
                var path = find_path(player, city, height_map);
                advancing += follow_path(player, path, height_map);
                player = city;
                city_name_banner.show();
                city_name_banner.text("Travelling to " + player.name + ", eta " + hours_to_date(advancing));
                console.log(describe_city(player));
            }
            
        }, false);
        window.addEventListener("mousemove", function (e) {
            if (time < advancing || dialogue) {
                return;
            }
            var city = select_city(e);
            if (city == undefined) {
                city_name_banner.hide();
            } else {
                city_name_banner.show();
                var text = city.name;
                if (city.voronoiId == home.voronoiId) {
                    text = "Your home city, " + text;
                } else if (city.voronoiId == port.voronoiId) {
                    text = "Port " + text;
                } else if (city.voronoiId == fortress.voronoiId) {
                    text = "The inquisition fortress, " + text;
                }
                if (city.voronoiId == player.voronoiId) {
                    text += " (You are here)";
                } else {
                    var path = find_path(player, city, height_map);
                    var cost = follow_path(player, path, height_map);
                    text += " (" + Math.ceil(cost) + " hours away)";
                }
                city_name_banner.text(text);
            }
            
        }, false);

        function animate() {
            requestAnimationFrame(animate);
            if (time < advancing && !dialogue) {
                var t = time;
                if (advancing - time < 1/20) {
                    time = advancing;
                    city_name_banner.hide();
                } else {
                    time += (advancing - time) / 60;
                }
                for (var e in scheduled_events) {
                    if (e > t && time >= e) {
                        scheduled_events[e]();
                    }
                }
            }
            light.position.set(
                    Math.sin(Math.PI*2/24*(time-4)) * 50,
                    50,
                    Math.cos(Math.PI*2/24*(time-4)) * 50
            );
            locator.position.set(player.x*50/512, -player.y*50/512, 8);
            locator.rotateY(0.01);
            renderer.render(scene, camera);
            status_banner.text(hours_to_date(time));
            if (!dialogue) dialogue_banner.hide();
        }
        animate();
        
        scheduled_events[30 * 24] = function () {
            display_dialogue(
                "The realisation that all is lost slowly dawns on you. The last ship to Aretta has sailed" +
                    (!daughter ? " and your only daughter will likely be burned at the stake for your sins" : "") +
                    ". The inquisition will find you eventually and burn you " + (daughter ? "and your daughter" : "too") + 
                    ", your flight more than proof to them of your guilt. Game Over.",
                [{text: "Try Again?", func: function() {window.location = window.location}}]
            );
        };
        
        display_dialogue(
            "It was late evening on Saturday the 10th of February and there had been a knock at your door, " +
            "outside stood a number of large men who said they needed to speak with you. You said you were " +
            "busy but they pressed the matter so you let them in. This was the first mistake. They were from " +
            "the inquisition, you had been accused of heresy and were instructed to make your way to the " +
            "inquisition fortress of " + fortress.name + " by " + hours_to_date(24 * 30) + ". To ensure your " +
            "cooperation they took your daughter, your one and only remaining family member, hostage. If you " +
            "didn't submit yourself, they would take this as proof of your guilt and punish her in your stead.",
            [
                {text: "Continue", func: function () {
                    display_dialogue(
                        "Once the inquisition had left, there was a second knock at the door. This time it was " +
                        "the local lord. He told you he had no love of the inquisition and was willing to offer " +
                        "you safe passage to Aretta on a boat leaving from Port " + port.name + ". However, no " +
                        "natter how much you begged he could not, or would not, offer you a second ticket. It " +
                        "was too dangerous, he said. Just get to " + port.name + ". Once the lord had left, you " +
                        "began to pack your things. You had to rescue your daughter from the fortress, but did " +
                        "not know how even to begin. You needed another ticket, found from somewhere. And you " +
                        "needed to make your way to " + port.name + ", all before " + hours_to_date(24 * 30) + ".",
                        [{text: "Let's go", func: function () {dialogue = false}}]
                    )
                }}
            ]
        );
    }
</script>
</body>
</html>